<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×›×œ×™ × ×™×ª×•×— ××¤×•×ª ×ª× ×•×¢×” | ×ª×§× ×” 168</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg-primary: #000000; --bg-secondary: #0a0a0a; --bg-card: #111111; --accent-red: #ef4444; --accent-green: #22c55e; --accent-yellow: #eab308; --accent-blue: #3b82f6; --accent-cyan: #06b6d4; --accent-purple: #a855f7; --accent-orange: #f97316; --text-primary: #ffffff; --text-secondary: #888888; --border-color: #222222; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Heebo', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        .container { max-width: 1900px; margin: 0 auto; padding: 1rem; }
        .header { text-align: center; margin-bottom: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary)); border-radius: 16px; border: 1px solid var(--border-color); }
        .header h1 { font-size: 1.8rem; font-weight: 800; background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue), var(--accent-purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .section { background: var(--bg-card); border-radius: 12px; padding: 1.25rem; border: 1px solid var(--border-color); margin-bottom: 1rem; }
        .section-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .upload-zone { border: 2px dashed var(--border-color); border-radius: 10px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s; }
        .upload-zone:hover { border-color: var(--accent-blue); background: rgba(59, 130, 246, 0.05); }
        .upload-zone.has-files { border-color: var(--accent-green); background: rgba(34, 197, 94, 0.05); }
        .upload-zone input { display: none; }
        .btn { padding: 0.5rem 1rem; border-radius: 8px; border: none; cursor: pointer; font-family: inherit; font-weight: 600; transition: all 0.2s; font-size: 0.85rem; }
        .btn-primary { background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan)); color: white; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .btn-secondary { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-warning { background: linear-gradient(135deg, var(--accent-orange), var(--accent-yellow)); color: #000; }
        .btn-muslim { background: linear-gradient(135deg, #059669, #10b981); color: white; }
        .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.75rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 0.6rem; margin-bottom: 1rem; }
        .stat-card { background: var(--bg-secondary); border-radius: 10px; padding: 0.8rem; text-align: center; }
        .stat-card .value { font-size: 1.4rem; font-weight: 700; }
        .stat-card .value.red { color: var(--accent-red); }
        .stat-card .value.green { color: var(--accent-green); }
        .stat-card .value.yellow { color: var(--accent-yellow); }
        .stat-card .value.blue { color: var(--accent-blue); }
        .stat-card .value.purple { color: var(--accent-purple); }
        .stat-card .value.cyan { color: var(--accent-cyan); }
        .stat-card .value.orange { color: var(--accent-orange); }
        .stat-card .label { color: var(--text-secondary); font-size: 0.7rem; margin-top: 0.2rem; }
        .stat-card .sub { font-size: 0.65rem; color: var(--accent-green); margin-top: 0.1rem; }
        .info-box { background: rgba(59, 130, 246, 0.1); border: 1px solid var(--accent-blue); border-radius: 10px; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.8rem; }
        .info-box.warning { background: rgba(234, 179, 8, 0.1); border-color: var(--accent-yellow); }
        .table-wrapper { overflow-x: auto; max-height: 600px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.72rem; }
        th, td { padding: 0.35rem 0.25rem; text-align: center; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        th { background: var(--bg-secondary); position: sticky; top: 0; z-index: 10; font-weight: 600; color: var(--text-secondary); cursor: pointer; font-size: 0.68rem; }
        th:hover { color: var(--accent-cyan); }
        tbody tr:hover { background: rgba(59, 130, 246, 0.1); }
        .badge { display: inline-block; padding: 0.15rem 0.35rem; border-radius: 4px; font-size: 0.62rem; font-weight: 600; }
        .badge-red { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .badge-yellow { background: rgba(234, 179, 8, 0.2); color: var(--accent-yellow); }
        .badge-green { background: rgba(34, 197, 94, 0.2); color: var(--accent-green); }
        .badge-blue { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }
        .badge-purple { background: rgba(168, 85, 247, 0.2); color: var(--accent-purple); }
        .badge-gray { background: rgba(148, 163, 184, 0.2); color: var(--text-secondary); }
        .badge-orange { background: rgba(249, 115, 22, 0.2); color: var(--accent-orange); }
        .badge-cyan { background: rgba(6, 182, 212, 0.2); color: var(--accent-cyan); }
        .filters { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap; align-items: center; }
        .filters select, .filters input { padding: 0.35rem 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-family: inherit; font-size: 0.8rem; }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .tab { padding: 0.5rem 1rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85rem; }
        .tab.active { background: var(--accent-blue); border-color: var(--accent-blue); }
        .highlight-row { background: rgba(239, 68, 68, 0.1) !important; }
        .warning-row { background: rgba(234, 179, 8, 0.1) !important; }
        .hidden { display: none; }
        .progress { width: 100%; height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden; margin: 0.5rem 0; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan)); transition: width 0.3s; }
        .chip { display: inline-block; padding: 0.2rem 0.5rem; background: var(--bg-secondary); border-radius: 4px; font-size: 0.75rem; margin: 0.1rem; }
        .chip-remove { cursor: pointer; margin-right: 0.3rem; color: var(--accent-red); }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.75rem; }
        .setting-item { display: flex; flex-direction: column; gap: 0.2rem; }
        .setting-item label { font-size: 0.75rem; color: var(--text-secondary); }
        .setting-item input, .setting-item select { padding: 0.35rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.85rem; }
        .collapsible { cursor: pointer; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; }
        .collapsible-content.open { max-height: 2000px; }
        .date-chips { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-top: 0.5rem; min-height: 30px; padding: 0.5rem; background: var(--bg-secondary); border-radius: 6px; }
        .holiday-section { margin-top: 0.5rem; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px; }
        .holiday-section-title { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.3rem; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸšŒ ×›×œ×™ × ×™×ª×•×— ××¤×•×ª ×ª× ×•×¢×”</h1>
            <p style="color: var(--text-secondary); font-size: 0.85rem;">××—×•×–×•×Ÿ ×“×™× ××™ ×œ×¤×™ ××§"×˜ â€¢ ×—×™×–×•×™ ××™-×‘×™×¦×•×¢ ×•××™-×“×™×•×§ â€¢ ×‘×“×™×§×ª ×ª×§× ×” 168 â€¢ × ×™×ª×•×— ×¨×™×§×•×ª</p>
        </header>

        <!-- Upload Section -->
        <div class="grid-2">
            <div class="section">
                <div class="section-title">ğŸ“‚ ×§×‘×¦×™ ×‘×™×¦×•×¢ (Actuals)</div>
                <div class="upload-zone" id="actualsZone" onclick="document.getElementById('actualsInput').click()">
                    <input type="file" id="actualsInput" multiple accept=".csv,.zip">
                    <div>ğŸ“ ×’×¨×•×¨ ×§×‘×¦×™ CSV ××• ×œ×—×¥ ×œ×‘×—×™×¨×”</div>
                </div>
                <div id="actualsFiles" style="margin-top: 0.5rem;"></div>
            </div>
            <div class="section">
                <div class="section-title">ğŸ—ºï¸ ××¤×ª ×ª× ×•×¢×” (Service Map)</div>
                <div class="upload-zone" id="mapZone" onclick="document.getElementById('mapInput').click()">
                    <input type="file" id="mapInput" accept=".csv">
                    <div>ğŸ“ ×’×¨×•×¨ ×§×•×‘×¥ CSV ××• ×œ×—×¥ ×œ×‘×—×™×¨×”</div>
                </div>
                <div id="mapFile" style="margin-top: 0.5rem;"></div>
            </div>
        </div>
        
        <!-- Deadhead Catalog Upload -->
        <div class="section">
            <div class="section-title">ğŸš ×§×˜×œ×•×’ ×¨×™×§×•×ª (××•×¤×¦×™×•× ×œ×™)</div>
            <div class="upload-zone" id="deadheadZone" onclick="document.getElementById('deadheadInput').click()" style="padding: 0.75rem;">
                <input type="file" id="deadheadInput" accept=".csv">
                <div style="font-size: 0.85rem;">ğŸ“ ×§×•×‘×¥ ×§×˜×œ×•×’ ×¨×™×§×•×ª</div>
            </div>
            <div id="deadheadFile" style="margin-top: 0.5rem;"></div>
            <div id="catalogInfo" style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-secondary);"></div>
        </div>

        <!-- Settings Section -->
        <div class="section">
            <div class="section-title collapsible" onclick="toggleCollapsible('settingsContent')">âš™ï¸ ×”×’×“×¨×•×ª <span style="font-size: 0.75rem; color: var(--text-secondary);">(×œ×—×¥ ×œ×”×¨×—×‘×”)</span></div>
            <div id="settingsContent" class="collapsible-content open">
                <div class="settings-grid">
                    <div class="setting-item">
                        <label>×™×¢×“ ××™-×‘×™×¦×•×¢ ××§×¡×™××œ×™ (%)</label>
                        <input type="number" id="targetNE" value="2" min="0" max="100" step="0.5">
                    </div>
                    <div class="setting-item">
                        <label>×™×¢×“ ××™-×“×™×•×§ ××§×¡×™××œ×™ (%)</label>
                        <input type="number" id="targetIN" value="3" min="0" max="100" step="0.5">
                    </div>
                    <div class="setting-item">
                        <label>×¡×£ ××™-×‘×™×¦×•×¢ (×“×§×•×ª)</label>
                        <input type="number" id="threshNE" value="20" min="1" max="60">
                    </div>
                    <div class="setting-item">
                        <label>×¡×£ ××™-×“×™×•×§ (×“×§×•×ª)</label>
                        <input type="number" id="threshIN" value="5" min="1" max="30">
                    </div>
                    <div class="setting-item">
                        <label>×¡×£ ×—×¨×™×’×ª ×¨×™×§×” (×“×§×•×ª)</label>
                        <input type="number" id="threshDeadhead" value="5" min="1" max="30">
                    </div>
                    <div class="setting-item">
                        <label>××§"×˜×™× ×œ×”×ª×¢×œ× (×‘×¢×™×™×ª GPS)</label>
                        <input type="text" id="ignoreRouteIds" value="" placeholder="×œ××©×œ: 36013,40013">
                    </div>
                    <div class="setting-item">
                        <label>××§"×˜×™× ×¢× ×–× ×‘ ×›×‘×“ (P95)</label>
                        <input type="text" id="heavyTailRouteIds" value="" placeholder="×œ××©×œ: 27013">
                    </div>
                </div>
                
                <div style="margin-top: 1rem;">
                    <label style="font-size: 0.85rem; font-weight: 600;">ğŸ“… ×”×—×¨×’×ª ×ª××¨×™×›×™×:</label>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; align-items: center;">
                        <input type="date" id="excludeDateInput" style="padding: 0.35rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary);">
                        <button class="btn btn-secondary btn-sm" onclick="addExcludeDate()">â• ×”×•×¡×£</button>
                        <button class="btn btn-secondary btn-sm" onclick="clearExcludeDates()">ğŸ—‘ï¸ × ×§×”</button>
                    </div>
                    
                    <div class="holiday-section">
                        <div class="holiday-section-title">ğŸ• ×—×’×™× ×™×©×¨××œ×™×™×:</div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-warning btn-sm" onclick="addIsraeliHolidays(2024)">×—×’×™× 2024</button>
                            <button class="btn btn-warning btn-sm" onclick="addIsraeliHolidays(2025)">×—×’×™× 2025</button>
                            <button class="btn btn-warning btn-sm" onclick="addIsraeliHolidays(2026)">×—×’×™× 2026</button>
                        </div>
                    </div>
                    
                    <div class="holiday-section">
                        <div class="holiday-section-title">ğŸ–ï¸ ×‘×™×Ÿ ×”×–×× ×™×:</div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-secondary btn-sm" onclick="addBeinHazmanim(2024)">×‘×™×Ÿ ×”×–×× ×™× 2024</button>
                            <button class="btn btn-secondary btn-sm" onclick="addBeinHazmanim(2025)">×‘×™×Ÿ ×”×–×× ×™× 2025</button>
                            <button class="btn btn-secondary btn-sm" onclick="addBeinHazmanim(2026)">×‘×™×Ÿ ×”×–×× ×™× 2026</button>
                        </div>
                    </div>
                    
                    <div class="holiday-section">
                        <div class="holiday-section-title">ğŸŒ™ ×—×’×™× ××•×¡×œ××™×™×:</div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-muslim btn-sm" onclick="addAllMuslimHolidays(2024)">×›×œ ×”×—×’×™× 2024</button>
                            <button class="btn btn-muslim btn-sm" onclick="addAllMuslimHolidays(2025)">×›×œ ×”×—×’×™× 2025</button>
                            <button class="btn btn-muslim btn-sm" onclick="addAllMuslimHolidays(2026)">×›×œ ×”×—×’×™× 2026</button>
                        </div>
                    </div>
                    
                    <div class="date-chips" id="excludeDateChips"></div>
                </div>
                
                <div style="margin-top: 0.75rem;">
                    <label><input type="checkbox" id="excludeWeekends" checked> ×”×—×¨×’ ×©×™×©×™-×©×‘×ª</label>
                </div>
            </div>
        </div>

        <!-- Analyze Button -->
        <div style="text-align: center; margin: 1rem 0;">
            <button class="btn btn-primary" onclick="analyze()" id="analyzeBtn" disabled style="font-size: 1.1rem; padding: 0.8rem 2rem;">
                ğŸ” × ×ª×— × ×ª×•× ×™×
            </button>
        </div>
        <div class="progress hidden" id="progressBar"><div class="progress-bar" style="width: 0%"></div></div>

        <!-- Results Section -->
        <div id="results" class="hidden">
            <div class="stats-grid" id="summaryStats"></div>
            
            <div class="info-box">
                <strong>ğŸ“Œ ×”×’×“×¨×•×ª:</strong>
                â€¢ <span style="color: var(--accent-red);">××™-×‘×™×¦×•×¢</span>: â‰¥<span id="infoNE">20</span> ×“×§' |
                â€¢ <span style="color: var(--accent-yellow);">××™-×“×™×•×§</span>: <span id="infoIN">5</span>-<span id="infoNE2">20</span> ×“×§' |
                â€¢ <span style="color: var(--accent-purple);">×ª×§× ×” 168</span>: ×”×¤×¡×§×” â‰¥30' ××• 2Ã—15' ×œ×›×œ 4 ×©×¢×•×ª
            </div>
            
            <div class="info-box warning" id="routeIdInfo" style="display:none;">
                <strong>âš ï¸ ×—×©×•×‘:</strong> ×”×ª×××ª × ×ª×•× ×™× ××ª×‘×¦×¢×ª ×œ×¤×™ <strong>××§"×˜ ×§×• (Route Id)</strong> ×•×œ× ×œ×¤×™ ××¡×¤×¨ ×§×• ×‘×œ×‘×“.
                ×§×• 13 ×‘×©×¨×•×Ÿ ×¢×™×¨×•× ×™ (××§"×˜ 36013) ×©×•× ×” ××§×• 13 ×‘×©×¨×•×Ÿ ×‘×™× ×¢×™×¨×•× ×™ (××§"×˜ 27013).
            </div>

            <div class="tabs">
                <div class="tab active" onclick="showTab('trips')">ğŸ“‹ × ×¡×™×¢×•×ª</div>
                <div class="tab" onclick="showTab('duties')">ğŸ‘¤ ×¡×™×“×•×¨×™× (168)</div>
                <div class="tab" onclick="showTab('routes')">ğŸšŒ ×§×•×•×™×</div>
                <div class="tab" onclick="showTab('deadheads')">ğŸš ×¨×™×§×•×ª</div>
            </div>

            <!-- Trips Tab -->
            <div id="tripsTab" class="section">
                <div class="filters">
                    <select id="filterRouteId"><option value="">×›×œ ×”××§"×˜×™×</option></select>
                    <select id="filterRoute"><option value="">×›×œ ×”×§×•×•×™×</option></select>
                    <select id="filterStatus">
                        <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                        <option value="fail_ne">×—×•×¨×’ NE</option>
                        <option value="fail_in">×—×•×¨×’ IN</option>
                        <option value="ok">×ª×§×™×Ÿ</option>
                        <option value="no_data">××™×Ÿ × ×ª×•× ×™×</option>
                    </select>
                    <select id="filterRec">
                        <option value="">×›×œ ×”×”××œ×¦×•×ª</option>
                        <option value="×œ×”×¢×œ×•×ª">×œ×”×¢×œ×•×ª</option>
                        <option value="×œ×‘×—×•×Ÿ ×”×¢×œ××”">×œ×‘×—×•×Ÿ ×”×¢×œ××”</option>
                        <option value="×œ×©××•×¨">×œ×©××•×¨</option>
                    </select>
                    <select id="filter168">
                        <option value="">168 - ×”×›×œ</option>
                        <option value="plan_fail">×ª×›× ×•×Ÿ âœ—</option>
                        <option value="actual_fail">××—×•×–×•×Ÿ âœ—</option>
                    </select>
                    <button class="btn btn-secondary btn-sm" onclick="exportTripsCSV()">ğŸ“¥ CSV</button>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead><tr>
                            <th onclick="sortTrips('duty_id')">×¡×™×“×•×¨</th>
                            <th onclick="sortTrips('route_id')">××§"×˜</th>
                            <th onclick="sortTrips('route')">×§×•</th>
                            <th onclick="sortTrips('direction')">×›×™×•×•×Ÿ</th>
                            <th onclick="sortTrips('start_time')">×™×¦×™××”</th>
                            <th onclick="sortTrips('planned')">×ª×›× ×•×Ÿ</th>
                            <th onclick="sortTrips('dynamic_pct')">××—×•×–×•×Ÿ</th>
                            <th onclick="sortTrips('pct_value')">×¢×¨×š</th>
                            <th onclick="sortTrips('gap_to_next')">×¤×¢×¨</th>
                            <th onclick="sortTrips('prob_non_exec')" title="×¡×™×›×•×™ ×‘××¦×‘ × ×•×›×—×™">NE × ×•×›×—×™</th>
                            <th onclick="sortTrips('prob_non_exec_rec')" title="×¡×™×›×•×™ ××—×¨×™ ××™××•×¥ ×”××œ×¦×”">NE ××—×¨×™</th>
                            <th onclick="sortTrips('prob_inaccuracy')" title="×¡×™×›×•×™ ×‘××¦×‘ × ×•×›×—×™">IN × ×•×›×—×™</th>
                            <th>×¡×˜×˜×•×¡</th>
                            <th>×”××œ×¦×”</th>
                            <th onclick="sortTrips('rec_duration')">×”×’×“×¨×”</th>
                            <th>168 ×ª×›× ×•×Ÿ</th>
                            <th>168 ××—×•×–×•×Ÿ</th>
                        </tr></thead>
                        <tbody id="tripsBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Duties Tab -->
            <div id="dutiesTab" class="section hidden">
                <div class="filters">
                    <select id="filterDuty168">
                        <option value="">×›×œ ×”×¡×™×“×•×¨×™×</option>
                        <option value="both_ok">×ª×›× ×•×Ÿ âœ“ + ××—×•×–×•×Ÿ âœ“</option>
                        <option value="plan_ok_actual_fail">×ª×›× ×•×Ÿ âœ“ ××‘×œ ××—×•×–×•×Ÿ âœ—</option>
                        <option value="plan_fail">×ª×›× ×•×Ÿ âœ—</option>
                    </select>
                    <button class="btn btn-secondary btn-sm" onclick="exportDutiesCSV()">ğŸ“¥ CSV</button>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead><tr>
                            <th onclick="sortDuties('duty_id')">×¡×™×“×•×¨</th>
                            <th>×”×ª×—×œ×”</th>
                            <th>×¡×™×•×</th>
                            <th onclick="sortDuties('total_duration')">××©×š</th>
                            <th onclick="sortDuties('plan_compliant')">168 ×ª×›× ×•×Ÿ</th>
                            <th onclick="sortDuties('actual_compliant')">168 ××—×•×–×•×Ÿ</th>
                        </tr></thead>
                        <tbody id="dutiesBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Routes Tab -->
            <div id="routesTab" class="section hidden">
                <div class="filters">
                    <select id="filterRoutesRouteId"><option value="">×›×œ ×”××§"×˜×™×</option></select>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead><tr>
                            <th onclick="sortRoutes('route_id')">××§"×˜</th>
                            <th onclick="sortRoutes('route')">×§×•</th>
                            <th onclick="sortRoutes('trips')">× ×¡×™×¢×•×ª</th>
                            <th onclick="sortRoutes('data_count')">× ×ª×•× ×™×</th>
                            <th>××—×•×–×•×Ÿ</th>
                            <th onclick="sortRoutes('avg_non_exec')">××™-×‘×™×¦×•×¢</th>
                            <th onclick="sortRoutes('avg_inaccuracy')">××™-×“×™×•×§</th>
                            <th onclick="sortRoutes('daily_non_exec')" title="× ×•×›×—×™ â†’ ××—×¨×™ ×”××œ×¦×”">×¦×¤×™ NE/×™×•×</th>
                            <th onclick="sortRoutes('rec_increase')">×œ×”×¢×œ×•×ª</th>
                        </tr></thead>
                        <tbody id="routesBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Deadheads Tab -->
            <div id="deadheadsTab" class="section hidden">
                <div class="info-box">
                    <strong>ğŸš × ×™×ª×•×— ×¨×™×§×•×ª:</strong> ×”×©×•×•××” ×‘×™×Ÿ ×–×× ×™ ×¨×™×§×” ×‘××¤×” ×œ×§×˜×œ×•×’.<br>
                    <span style="color: var(--accent-orange);">âš ï¸ ×—×¡×¨ ×‘××¤×”</span> = ×”××¤×” ×œ× ×›×•×œ×œ×ª ×–××Ÿ ×¨×™×§×” |
                    <span style="color: var(--accent-red);">LONG</span> = ××¤×” > ×§×˜×œ×•×’ |
                    <span style="color: var(--accent-yellow);">SHORT</span> = ××¤×” < ×§×˜×œ×•×’ |
                    <span style="color: var(--accent-green);">OK</span> = ×ª×§×™×Ÿ |
                    <span style="color: var(--accent-purple);">×—×¡×¨ ×‘×§×˜×œ×•×’</span> = ××™×Ÿ ×‘×§×˜×œ×•×’
                </div>
                <div class="filters">
                    <select id="filterDeadheadStatus">
                        <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                        <option value="map_zero">âš ï¸ ×—×¡×¨ ×‘××¤×”</option>
                        <option value="catalog_missing">×—×¡×¨ ×‘×§×˜×œ×•×’</option>
                        <option value="long">LONG - ××¤×” ××¨×•×š</option>
                        <option value="short">SHORT - ××¤×” ×§×¦×¨</option>
                        <option value="ok">OK - ×ª×§×™×Ÿ</option>
                    </select>
                    <select id="filterDeadheadSeason">
                        <option value="">×›×œ ×”×¢×•× ×•×ª</option>
                        <option value="morning_peak">×©×™× ×‘×•×§×¨</option>
                        <option value="midday">×©×¤×œ ×™×•×</option>
                        <option value="afternoon_peak">×©×™× ×¦×”×¨×™×™×</option>
                        <option value="evening">×¢×¨×‘</option>
                        <option value="night">×œ×™×œ×”</option>
                    </select>
                    <button class="btn btn-secondary btn-sm" onclick="exportDeadheadsCSV()">ğŸ“¥ CSV</button>
                </div>
                <div id="deadheadsSummary" class="stats-grid" style="margin-bottom: 1rem;"></div>
                <div class="table-wrapper">
                    <table>
                        <thead><tr>
                            <th onclick="sortDeadheads('duty_id')">×¡×™×“×•×¨</th>
                            <th onclick="sortDeadheads('start_time')">×©×¢×”</th>
                            <th>×¢×•× ×”</th>
                            <th>××•×¦×</th>
                            <th>×™×¢×“</th>
                            <th onclick="sortDeadheads('map_duration')">××¤×” (×“×§')</th>
                            <th onclick="sortDeadheads('catalog_duration')">×§×˜×œ×•×’ (×“×§')</th>
                            <th onclick="sortDeadheads('diff')">×¤×¢×¨</th>
                            <th>×¡×˜×˜×•×¡</th>
                        </tr></thead>
                        <tbody id="deadheadsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <footer style="text-align: center; padding: 2rem 1rem; color: var(--text-secondary); font-size: 0.75rem; border-top: 1px solid var(--border-color); margin-top: 2rem;">
        <p>×›×œ×™ × ×™×ª×•×— ××¤×•×ª ×ª× ×•×¢×” | ×’×¨×¡×” 3.5</p>
        <p>×”×ª×××” ×œ×¤×™ ××§"×˜ ×§×• â€¢ ××—×•×–×•×Ÿ ×“×™× ××™ â€¢ ×ª×§× ×” 168</p>
    </footer>

    <script>
    // === Holiday Data ===
    function generateDateRange(startDate, endDate) {
        const dates = [];
        const current = new Date(startDate);
        const end = new Date(endDate);
        while (current <= end) {
            dates.push(current.toISOString().split('T')[0]);
            current.setDate(current.getDate() + 1);
        }
        return dates;
    }
    
    const ISRAELI_HOLIDAYS = {
        2024: ['2024-04-23','2024-04-24','2024-04-25','2024-04-26','2024-04-27','2024-04-28','2024-04-29','2024-05-14','2024-05-26','2024-06-11','2024-06-12','2024-10-03','2024-10-04','2024-10-12','2024-10-17','2024-10-18','2024-10-19','2024-10-20','2024-10-21','2024-10-22','2024-10-23','2024-10-24'],
        2025: ['2025-04-13','2025-04-14','2025-04-15','2025-04-16','2025-04-17','2025-04-18','2025-04-19','2025-05-01','2025-05-18','2025-06-02','2025-06-03','2025-09-23','2025-09-24','2025-10-02','2025-10-07','2025-10-08','2025-10-09','2025-10-10','2025-10-11','2025-10-12','2025-10-13','2025-10-14'],
        2026: ['2026-04-02','2026-04-03','2026-04-04','2026-04-05','2026-04-06','2026-04-07','2026-04-08','2026-04-22','2026-05-07','2026-05-22','2026-05-23','2026-09-12','2026-09-13','2026-09-21','2026-09-26','2026-09-27','2026-09-28','2026-09-29','2026-09-30','2026-10-01','2026-10-02','2026-10-03']
    };
    const BEIN_HAZMANIM = { 2024: generateDateRange('2024-07-01', '2024-08-31'), 2025: generateDateRange('2025-07-01', '2025-08-31'), 2026: generateDateRange('2026-07-01', '2026-08-31') };
    const RAMADAN = { 2024: generateDateRange('2024-03-10', '2024-04-09'), 2025: generateDateRange('2025-02-28', '2025-03-29'), 2026: generateDateRange('2026-02-17', '2026-03-18') };
    const EID_FITR = { 2024: ['2024-04-10','2024-04-11','2024-04-12'], 2025: ['2025-03-30','2025-03-31','2025-04-01'], 2026: ['2026-03-19','2026-03-20','2026-03-21'] };
    const EID_ADHA = { 2024: ['2024-06-16','2024-06-17','2024-06-18','2024-06-19'], 2025: ['2025-06-06','2025-06-07','2025-06-08','2025-06-09'], 2026: ['2026-05-26','2026-05-27','2026-05-28','2026-05-29'] };

    // === State ===
    let actualsData = [], mapData = [], tripsResults = [], dutiesResults = [], routesResults = [];
    let deadheadCatalog = [], deadheadCatalogMap = {}, deadheadsResults = [];
    let dutiesRawEvents = {};
    let excludeDates = new Set();
    let tripsSortCol = 'prob_non_exec', tripsSortDir = 'desc';
    let deadheadsSortCol = 'status', deadheadsSortDir = 'asc';
    let routesSortCol = 'avg_non_exec', routesSortDir = 'desc';

    // === Event Listeners ===
    document.getElementById('actualsInput').addEventListener('change', handleActualsUpload);
    document.getElementById('mapInput').addEventListener('change', handleMapUpload);
    document.getElementById('deadheadInput').addEventListener('change', handleDeadheadCatalogUpload);

    // === Holiday Functions ===
    function addExcludeDate() {
        const input = document.getElementById('excludeDateInput');
        if (input.value) { excludeDates.add(input.value); renderExcludeDates(); input.value = ''; }
    }
    function addIsraeliHolidays(year) { if (ISRAELI_HOLIDAYS[year]) { ISRAELI_HOLIDAYS[year].forEach(d => excludeDates.add(d)); renderExcludeDates(); } }
    function addBeinHazmanim(year) { if (BEIN_HAZMANIM[year]) { BEIN_HAZMANIM[year].forEach(d => excludeDates.add(d)); renderExcludeDates(); } }
    function addAllMuslimHolidays(year) { 
        if (RAMADAN[year]) RAMADAN[year].forEach(d => excludeDates.add(d));
        if (EID_FITR[year]) EID_FITR[year].forEach(d => excludeDates.add(d));
        if (EID_ADHA[year]) EID_ADHA[year].forEach(d => excludeDates.add(d));
        renderExcludeDates(); 
    }
    function clearExcludeDates() { excludeDates.clear(); renderExcludeDates(); }
    function removeExcludeDate(date) { excludeDates.delete(date); renderExcludeDates(); }
    
    function renderExcludeDates() {
        const sorted = [...excludeDates].sort();
        const count = sorted.length;
        if (count === 0) {
            document.getElementById('excludeDateChips').innerHTML = '<span style="color: var(--text-secondary); font-size: 0.8rem;">×œ× × ×‘×—×¨×• ×ª××¨×™×›×™×</span>';
            return;
        }
        let html = `<div style="width: 100%; margin-bottom: 0.3rem; font-size: 0.8rem; color: var(--text-secondary);">ğŸ“… ${count} ×ª××¨×™×›×™× ××•×—×¨×’×™×</div>`;
        if (count > 15) {
            html += sorted.slice(0, 8).map(d => `<span class="chip"><span class="chip-remove" onclick="removeExcludeDate('${d}')">âœ•</span>${new Date(d).toLocaleDateString('he-IL')}</span>`).join('');
            html += `<span style="padding: 0.3rem; color: var(--text-secondary);">... ${count - 13} × ×•×¡×¤×™× ...</span>`;
            html += sorted.slice(-5).map(d => `<span class="chip"><span class="chip-remove" onclick="removeExcludeDate('${d}')">âœ•</span>${new Date(d).toLocaleDateString('he-IL')}</span>`).join('');
        } else {
            html += sorted.map(d => `<span class="chip"><span class="chip-remove" onclick="removeExcludeDate('${d}')">âœ•</span>${new Date(d).toLocaleDateString('he-IL')}</span>`).join('');
        }
        document.getElementById('excludeDateChips').innerHTML = html;
    }

    // === File Upload Handlers ===
    async function handleDeadheadCatalogUpload(e) {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('deadheadZone').classList.add('has-files');
            document.getElementById('deadheadFile').innerHTML = `<span class="chip">ğŸ“„ ${file.name}</span>`;
            const text = await file.text();
            deadheadCatalog = parseCSV(text);
            
            deadheadCatalogMap = {};
            let validEntries = 0;
            for (const row of deadheadCatalog) {
                const originId = row['Origin Stop Id'];
                const destId = row['Destination Stop Id'];
                const travelTime = parseFloat(row['Travel Time']);
                if (originId && destId && !isNaN(travelTime)) {
                    const key = `${originId}_${destId}`;
                    if (!deadheadCatalogMap[key]) {
                        deadheadCatalogMap[key] = { time: travelTime, count: 1 };
                    } else {
                        const existing = deadheadCatalogMap[key];
                        existing.time = (existing.time * existing.count + travelTime) / (existing.count + 1);
                        existing.count++;
                    }
                    validEntries++;
                }
            }
            
            const uniquePairs = Object.keys(deadheadCatalogMap).length;
            document.getElementById('catalogInfo').innerHTML = `âœ… × ×˜×¢× ×• ${validEntries} ×¨×©×•××•×ª, ${uniquePairs} ×–×•×’×•×ª ××•×¦×-×™×¢×“ ×™×™×—×•×“×™×™×`;
        }
    }

    async function handleActualsUpload(e) {
        const files = e.target.files;
        if (files.length > 0) {
            document.getElementById('actualsZone').classList.add('has-files');
            document.getElementById('actualsFiles').innerHTML = Array.from(files).map(f => `<span class="chip">ğŸ“„ ${f.name}</span>`).join('');
            actualsData = [];
            for (const file of files) {
                const text = await file.text();
                actualsData = actualsData.concat(parseCSV(text));
            }
            checkReadyToAnalyze();
        }
    }

    function handleMapUpload(e) {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('mapZone').classList.add('has-files');
            document.getElementById('mapFile').innerHTML = `<span class="chip">ğŸ“„ ${file.name}</span>`;
            const reader = new FileReader();
            reader.onload = (ev) => { mapData = parseCSV(ev.target.result); checkReadyToAnalyze(); };
            reader.readAsText(file);
        }
    }

    function parseCSV(text) {
        const lines = text.split('\n').filter(l => l.trim());
        if (lines.length < 2) return [];
        let headerLine = lines[0];
        if (headerLine.charCodeAt(0) === 0xFEFF) headerLine = headerLine.slice(1);
        const headers = headerLine.split(',').map(h => h.trim().replace(/"/g, '').replace(/\r/g, ''));
        return lines.slice(1).map(line => {
            const values = line.split(',').map(v => v.trim().replace(/"/g, '').replace(/\r/g, ''));
            const row = {};
            headers.forEach((h, i) => row[h] = values[i] || '');
            return row;
        });
    }

    function checkReadyToAnalyze() {
        document.getElementById('analyzeBtn').disabled = !(actualsData.length > 0 && mapData.length > 0);
    }

    // === Utility Functions ===
    function toggleCollapsible(id) { document.getElementById(id).classList.toggle('open'); }
    
    function showTab(tab) {
        document.querySelectorAll('.tab').forEach((t, i) => {
            t.classList.toggle('active', 
                (tab==='trips'&&i===0)||(tab==='duties'&&i===1)||(tab==='routes'&&i===2)||(tab==='deadheads'&&i===3));
        });
        document.getElementById('tripsTab').classList.toggle('hidden', tab !== 'trips');
        document.getElementById('dutiesTab').classList.toggle('hidden', tab !== 'duties');
        document.getElementById('routesTab').classList.toggle('hidden', tab !== 'routes');
        document.getElementById('deadheadsTab').classList.toggle('hidden', tab !== 'deadheads');
    }

    function timeToMinutes(t) { if (!t) return null; const p = t.toString().split(':'); return parseInt(p[0]) * 60 + parseInt(p[1]); }
    function minutesToTime(m) { return `${Math.floor(m/60)%24}:${(m%60).toString().padStart(2,'0')}`; }
    function parseDuration(d) { if (!d || d === '#') return null; const p = d.toString().split(':'); return p.length >= 2 ? parseInt(p[0])*60 + parseInt(p[1]) : null; }
    
    function isExcludedDate(dateStr) {
        if (!dateStr) return true;
        try {
            const p = dateStr.split('/');
            const date = new Date(parseInt(p[2]), parseInt(p[1])-1, parseInt(p[0]));
            if (excludeDates.has(date.toISOString().split('T')[0])) return true;
            if (document.getElementById('excludeWeekends').checked && (date.getDay()===5||date.getDay()===6)) return true;
        } catch(e) { return true; }
        return false;
    }

    function getSeasonFromTime(minutes) {
        const hour = Math.floor((minutes % 1440) / 60);
        if (hour >= 6 && hour < 9) return { key: 'morning_peak', label: '×©×™× ×‘×•×§×¨' };
        if (hour >= 9 && hour < 15) return { key: 'midday', label: '×©×¤×œ ×™×•×' };
        if (hour >= 15 && hour < 19) return { key: 'afternoon_peak', label: '×©×™× ×¦×”×¨×™×™×' };
        if (hour >= 19 && hour < 23) return { key: 'evening', label: '×¢×¨×‘' };
        return { key: 'night', label: '×œ×™×œ×”' };
    }

    // *** KEY FIX: Use RouteId for percentile settings ***
    function getDynamicPercentile(routeId, hour) {
        const ignore = document.getElementById('ignoreRouteIds').value.split(',').map(r => r.trim()).filter(r => r);
        const heavy = document.getElementById('heavyTailRouteIds').value.split(',').map(r => r.trim()).filter(r => r);
        
        const routeIdStr = String(routeId);
        if (ignore.includes(routeIdStr)) return { pct: 0, label: 'GPS', ignore: true };
        if (heavy.includes(routeIdStr)) return { pct: 95, label: 'P95', ignore: false };
        
        if (hour >= 6 && hour < 9) return { pct: 90, label: 'P90', ignore: false };
        if (hour >= 9 && hour < 15) return { pct: 85, label: 'P85', ignore: false };
        if (hour >= 15 && hour < 19) return { pct: 90, label: 'P90', ignore: false };
        return { pct: 80, label: 'P80', ignore: false };
    }

    function percentile(arr, p) {
        const s = [...arr].sort((a,b) => a-b);
        const i = (p/100) * (s.length-1);
        const l = Math.floor(i);
        return l+1 < s.length ? s[l]*(1-(i-l)) + s[l+1]*(i-l) : s[l];
    }

    function logNormalCDF(x, mu, sigma) {
        if (x <= 0) return 0;
        return 0.5 * (1 + erf((Math.log(x) - mu) / (sigma * Math.sqrt(2))));
    }
    function erf(x) {
        const a1=0.254829592,a2=-0.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429,p=0.3275911;
        const sign = x<0?-1:1; x=Math.abs(x);
        const t=1/(1+p*x);
        return sign*(1-(((((a5*t+a4)*t)+a3)*t+a2)*t+a1)*t*Math.exp(-x*x));
    }
    function fitLogNormal(data) {
        if (data.length < 5) return null;
        const log = data.filter(d => d>0).map(d => Math.log(d));
        const mu = log.reduce((a,b) => a+b, 0) / log.length;
        const sigma = Math.sqrt(log.reduce((a,b) => a + (b-mu)**2, 0) / log.length);
        return { mu, sigma };
    }

    function checkRule168(events, useActual, tripDurations) {
        const breakTypes = ['standby', 'break', 'meal_break', 'split'];
        const workEvents = events.filter(e => e.eventType === 'service_trip' || e.eventType === 'deadhead' || breakTypes.includes(e.eventType));
        const driving = workEvents.filter(e => e.eventType === 'service_trip' || e.eventType === 'deadhead');
        if (driving.length === 0) return { compliant: true, segments: [], details: '××™×Ÿ × ×”×™×’×”' };
        
        const adjusted = workEvents.map(e => {
            const start = timeToMinutes(e.startTime) + e.dayOffset * 1440;
            let end = timeToMinutes(e.endTime) + e.dayOffset * 1440;
            if (end < start) end += 1440;
            if (useActual && e.eventType === 'service_trip') {
                const key = `${e.routeId}-${e.direction}-${e.startTime}`;
                if (tripDurations[key]) end = start + tripDurations[key];
            }
            return { ...e, start, end };
        }).sort((a, b) => a.start - b.start);
        
        const drivingAdj = adjusted.filter(e => e.eventType === 'service_trip' || e.eventType === 'deadhead');
        const firstDriveStart = drivingAdj[0].start;
        const lastEnd = Math.max(...drivingAdj.map(e => e.end));
        const totalDuration = lastEnd - firstDriveStart;
        if (totalDuration < 240) return { compliant: true, segments: [], details: `< 4 ×©×¢×•×ª` };
        
        const segments = [];
        let segStart = firstDriveStart;
        let segNum = 1;
        
        while (segStart < lastEnd && segNum <= 10) {
            const actualSegEnd = Math.min(segStart + 240, lastEnd);
            const breaks = [];
            adjusted.filter(e => breakTypes.includes(e.eventType)).forEach(e => {
                if (e.end <= segStart || e.start >= actualSegEnd) return;
                const overlap = Math.min(e.end, actualSegEnd) - Math.max(e.start, segStart);
                if (overlap > 0) breaks.push({ overlap, full: e.end - e.start });
            });
            
            const totalBreak = breaks.reduce((a, b) => a + b.overlap, 0);
            const breaks15 = breaks.filter(b => b.overlap >= 15).length;
            const has30 = breaks.some(b => b.full >= 30);
            let isOk = has30 || (breaks15 >= 2 && totalBreak >= 30);
            if (actualSegEnd - segStart < 180) isOk = true;
            
            segments.push({ num: segNum, isOk });
            segStart += 240;
            segNum++;
        }
        
        const allOk = segments.every(s => s.isOk);
        return { compliant: allOk, segments, details: allOk ? 'âœ“' : `××§×˜×¢×™×: ${segments.filter(s => !s.isOk).map(s => s.num).join(',')}` };
    }

    // === Main Analysis ===
    async function analyze() {
        const btn = document.getElementById('analyzeBtn');
        const progress = document.getElementById('progressBar');
        btn.disabled = true; btn.textContent = 'â³ ×× ×ª×—...';
        progress.classList.remove('hidden');
        
        const targetNE = parseFloat(document.getElementById('targetNE').value);
        const targetIN = parseFloat(document.getElementById('targetIN').value);
        const threshNE = parseInt(document.getElementById('threshNE').value);
        const threshIN = parseInt(document.getElementById('threshIN').value);
        const threshDeadhead = parseInt(document.getElementById('threshDeadhead').value);
        
        document.getElementById('infoNE').textContent = threshNE;
        document.getElementById('infoNE2').textContent = threshNE;
        document.getElementById('infoIN').textContent = threshIN;

        await new Promise(r => setTimeout(r, 10));
        progress.querySelector('.progress-bar').style.width = '10%';

        // === BUILD ACTUALS MAP ===
        const filtered = actualsData.filter(row => !isExcludedDate(row.TripSourceDate));
        const actualsMap = {};  // Key: RouteId-Direction-TimeBucket
        const routeIdsInActuals = new Set();
        
        for (const row of filtered) {
            const routeId = row.RouteId;
            const dir = parseInt(row.Direction);
            const time = timeToMinutes(row.TripSourceTime);
            const dur = parseDuration(row.Duration);
            
            if (!routeId || isNaN(dir) || time === null || dur === null || dur <= 0 || dur > 180) continue;
            
            routeIdsInActuals.add(routeId);
            const bucket = Math.round(time / 10) * 10;
            const key = `${routeId}-${dir}-${bucket}`;
            
            if (!actualsMap[key]) actualsMap[key] = [];
            actualsMap[key].push(dur);
        }
        
        console.log(`ğŸ“Š Actuals: ${filtered.length} valid records, ${routeIdsInActuals.size} unique RouteIds`);

        await new Promise(r => setTimeout(r, 10));
        progress.querySelector('.progress-bar').style.width = '30%';

        // === PARSE MAP ===
        const duties = {};
        const routeIdsInMap = new Set();
        
        for (const row of mapData) {
            const dutyId = row['Duty id'];
            if (!dutyId) continue;
            if (!duties[dutyId]) duties[dutyId] = [];
            
            // Extract numeric RouteId from format like "10236-1-0" â†’ "10236"
            let rawRouteId = row['Route Id'] || '';
            let numericRouteId = rawRouteId ? rawRouteId.split('-')[0] : null;
            
            // Validate numericRouteId is actually numeric
            if (numericRouteId && !/^\d+$/.test(numericRouteId)) {
                numericRouteId = null;
            }
            
            const eventType = row['Event Type'];
            if (eventType === 'service_trip' && numericRouteId) {
                routeIdsInMap.add(numericRouteId);
            }
            
            duties[dutyId].push({
                eventType: eventType,
                routeId: numericRouteId,
                rawRouteId: rawRouteId,
                route: parseInt(row['Sign']) || null,
                direction: parseInt(row['Direction']) || null,
                startTime: row['Start Time'],
                endTime: row['End Time'],
                dayOffset: parseInt(row['Day Offset']) || 0,
                originStopId: row['Origin Stop Id'],
                destStopId: row['Destination Stop Id'],
                originStopName: row['Origin Stop Name'] || row['Origin Stop Id'],
                destStopName: row['Destination Stop Name'] || row['Destination Stop Id']
            });
        }
        
        // Check RouteId overlap
        const matchedRouteIds = [...routeIdsInMap].filter(rid => routeIdsInActuals.has(rid));
        const unmatchedRouteIds = [...routeIdsInMap].filter(rid => !routeIdsInActuals.has(rid));
        console.log(`ğŸ—ºï¸ Map: ${routeIdsInMap.size} RouteIds, ${matchedRouteIds.length} matched, ${unmatchedRouteIds.length} unmatched`);
        if (unmatchedRouteIds.length > 0) {
            console.warn(`âš ï¸ Unmatched RouteIds:`, unmatchedRouteIds.join(', '));
        }

        await new Promise(r => setTimeout(r, 10));
        progress.querySelector('.progress-bar').style.width = '50%';

        // Process trips and duties
        tripsResults = [];
        dutiesResults = [];
        deadheadsResults = [];
        dutiesRawEvents = {};
        
        let tripsWithData = 0, tripsWithoutData = 0, tripsPartialData = 0;
        
        for (const [dutyId, events] of Object.entries(duties)) {
            events.sort((a, b) => (timeToMinutes(a.startTime) + a.dayOffset*1440) - (timeToMinutes(b.startTime) + b.dayOffset*1440));
            dutiesRawEvents[dutyId] = events;

            const plan168 = checkRule168(events, false, {});
            const tripDurations = {};
            const serviceTrips = events.filter(e => e.eventType === 'service_trip');
            
            // Process service trips
            for (let i = 0; i < serviceTrips.length; i++) {
                const trip = serviceTrips[i];
                const startMin = timeToMinutes(trip.startTime) + trip.dayOffset * 1440;
                let endMin = timeToMinutes(trip.endTime) + trip.dayOffset * 1440;
                if (endMin < startMin) endMin += 1440;
                const planned = endMin - startMin;
                const hour = Math.floor((startMin % 1440) / 60);
                
                const nextTrip = serviceTrips[i + 1];
                const isLast = !nextTrip;
                let gapToNext = 0;
                if (nextTrip) gapToNext = (timeToMinutes(nextTrip.startTime) + nextTrip.dayOffset * 1440) - startMin;
                
                const bucket = Math.round((startMin % 1440) / 10) * 10;
                
                // *** Use RouteId for matching actuals ***
                const key = `${trip.routeId}-${trip.direction}-${bucket}`;
                let durs = actualsMap[key] || [];
                let matchSource = durs.length > 0 ? 'exact' : 'none';
                
                // If no data for this RouteId, try nearby time buckets
                if (durs.length < 10) {
                    const nearbyBuckets = [bucket - 10, bucket + 10, bucket - 20, bucket + 20];
                    for (const nb of nearbyBuckets) {
                        const nearbyKey = `${trip.routeId}-${trip.direction}-${nb}`;
                        if (actualsMap[nearbyKey]) {
                            durs = durs.concat(actualsMap[nearbyKey]);
                            if (matchSource === 'none') matchSource = 'nearby';
                        }
                        if (durs.length >= 10) break;
                    }
                }
                
                // Track matching stats
                if (durs.length >= 10) {
                    tripsWithData++;
                } else if (durs.length > 0) {
                    tripsPartialData++;
                } else {
                    tripsWithoutData++;
                }
                
                const noData = durs.length < 10;
                const dataCount = durs.length;
                const dynPct = getDynamicPercentile(trip.routeId, hour);
                const pctValue = noData ? planned : (dynPct.ignore ? planned : percentile(durs, dynPct.pct));
                tripDurations[`${trip.routeId}-${trip.direction}-${trip.startTime}`] = pctValue;
                
                let probNE = null, probIN = null;
                let probNE_rec = null, probIN_rec = null;
                let fit = null;
                
                if (!noData && !dynPct.ignore && gapToNext > 0) {
                    fit = fitLogNormal(durs);
                    if (fit) {
                        probNE = (1 - logNormalCDF(gapToNext + threshNE, fit.mu, fit.sigma)) * 100;
                        probIN = (logNormalCDF(gapToNext + threshNE, fit.mu, fit.sigma) - logNormalCDF(gapToNext + threshIN, fit.mu, fit.sigma)) * 100;
                    }
                } else if (dynPct.ignore) {
                    probNE = 0; probIN = 0;
                }
                
                // *** FIXED RECOMMENDATION LOGIC ***
                let rec = noData ? '××™×Ÿ × ×ª×•× ×™×' : '×œ×©××•×¨';
                let recDur = planned;
                
                if (!noData && !dynPct.ignore && gapToNext > 0 && probNE !== null) {
                    if (probNE > targetNE) {
                        // Only recommend increase if pctValue > planned
                        if (pctValue > planned) {
                            rec = '×œ×”×¢×œ×•×ª';
                            recDur = Math.ceil(pctValue);
                        } else {
                            // Plan is already higher than percentile
                            rec = '×œ×‘×—×•×Ÿ ×”×¢×œ××”';
                            recDur = planned;
                        }
                    } else if (probIN > targetIN) {
                        if (pctValue > planned) {
                            rec = '×œ×‘×—×•×Ÿ ×”×¢×œ××”';
                            recDur = Math.ceil(pctValue);
                        }
                    }
                }
                
                // Calculate probabilities after recommendation
                if (fit && recDur !== planned) {
                    const newGap = gapToNext + (recDur - planned);
                    probNE_rec = (1 - logNormalCDF(newGap + threshNE, fit.mu, fit.sigma)) * 100;
                    probIN_rec = (logNormalCDF(newGap + threshNE, fit.mu, fit.sigma) - logNormalCDF(newGap + threshIN, fit.mu, fit.sigma)) * 100;
                } else {
                    probNE_rec = probNE;
                    probIN_rec = probIN;
                }
                
                tripsResults.push({
                    duty_id: dutyId, 
                    route_id: trip.routeId,  // ××§"×˜ ×§×•
                    route: trip.route,  // ××¡×¤×¨ ×§×•
                    direction: trip.direction, 
                    start_time: trip.startTime, 
                    hour, 
                    planned,
                    dynamic_pct: noData ? 'N/A' : dynPct.label, 
                    pct_value: pctValue, 
                    gap_to_next: gapToNext, 
                    is_last: isLast,
                    prob_non_exec: probNE, 
                    prob_inaccuracy: probIN,
                    prob_non_exec_rec: probNE_rec, 
                    prob_inaccuracy_rec: probIN_rec,
                    rec, 
                    rec_duration: recDur, 
                    is_ignored: dynPct.ignore, 
                    no_data: noData,
                    data_count: dataCount
                });
            }
            
            // Process deadheads
            const deadheadEvents = events.filter(e => e.eventType === 'deadhead');
            for (const dh of deadheadEvents) {
                const startMin = timeToMinutes(dh.startTime) + dh.dayOffset * 1440;
                let endMin = timeToMinutes(dh.endTime) + dh.dayOffset * 1440;
                if (endMin < startMin) endMin += 1440;
                const mapDuration = endMin - startMin;
                
                const season = getSeasonFromTime(startMin);
                const catalogKey = `${dh.originStopId}_${dh.destStopId}`;
                const catalogEntry = deadheadCatalogMap[catalogKey];
                const catalogDuration = catalogEntry ? Math.round(catalogEntry.time) : null;
                
                let diff = null;
                let status = 'catalog_missing';
                let statusLabel = '×—×¡×¨ ×‘×§×˜×œ×•×’';
                
                if (mapDuration === 0 && catalogDuration !== null) {
                    status = 'map_zero';
                    statusLabel = 'âš ï¸ ×—×¡×¨ ×‘××¤×”';
                    diff = -catalogDuration;
                } else if (mapDuration === 0 && catalogDuration === null) {
                    status = 'catalog_missing';
                    statusLabel = '×—×¡×¨ ×‘×§×˜×œ×•×’';
                } else if (catalogDuration !== null) {
                    diff = mapDuration - catalogDuration;
                    if (diff > threshDeadhead) {
                        status = 'long'; statusLabel = 'LONG';
                    } else if (diff < -threshDeadhead) {
                        status = 'short'; statusLabel = 'SHORT';
                    } else {
                        status = 'ok'; statusLabel = 'OK';
                    }
                }
                
                deadheadsResults.push({
                    duty_id: dutyId, start_time: dh.startTime, season_key: season.key, season_label: season.label,
                    origin_id: dh.originStopId, dest_id: dh.destStopId, origin_name: dh.originStopName, dest_name: dh.destStopName,
                    map_duration: mapDuration, catalog_duration: catalogDuration, diff: diff, status: status, status_label: statusLabel
                });
            }
            
            const actual168 = checkRule168(events, true, tripDurations);
            
            const firstDrive = events.find(e => e.eventType === 'service_trip');
            const lastEvent = events[events.length - 1];
            let totalDur = 0;
            if (firstDrive && lastEvent) {
                const s = timeToMinutes(firstDrive.startTime) + firstDrive.dayOffset * 1440;
                let e = timeToMinutes(lastEvent.endTime) + lastEvent.dayOffset * 1440;
                if (e < s) e += 1440;
                totalDur = e - s;
            }
            
            dutiesResults.push({
                duty_id: dutyId, startTime: firstDrive?.startTime || '', endTime: lastEvent?.endTime || '',
                total_duration: totalDur, plan_compliant: plan168.compliant, actual_compliant: actual168.compliant
            });
            
            tripsResults.filter(t => t.duty_id === dutyId).forEach(t => {
                t.duty_168_plan = plan168.compliant;
                t.duty_168_actual = actual168.compliant;
            });
        }

        await new Promise(r => setTimeout(r, 10));
        progress.querySelector('.progress-bar').style.width = '80%';

        // Routes summary - group by RouteId
        routesResults = [];
        const groups = {};
        tripsResults.filter(t => !t.is_last && !t.no_data).forEach(t => {
            const key = t.route_id || t.route;
            if (!groups[key]) groups[key] = { route_id: t.route_id, route: t.route, trips: [] };
            groups[key].trips.push(t);
        });
        
        for (const [key, group] of Object.entries(groups)) {
            const trips = group.trips;
            const dynPct = getDynamicPercentile(group.route_id, 12);
            const validTrips = trips.filter(t => t.prob_non_exec !== null);
            const avgDataCount = trips.reduce((a, t) => a + (t.data_count || 0), 0) / trips.length;
            
            routesResults.push({
                route_id: group.route_id,
                route: group.route,
                trips: trips.length,
                data_count: Math.round(avgDataCount),
                pct_label: dynPct.ignore ? 'GPS' : dynPct.label,
                avg_non_exec: validTrips.length > 0 ? validTrips.reduce((a,t) => a + (t.prob_non_exec || 0), 0) / validTrips.length : 0,
                avg_inaccuracy: validTrips.length > 0 ? validTrips.reduce((a,t) => a + (t.prob_inaccuracy || 0), 0) / validTrips.length : 0,
                daily_non_exec: validTrips.reduce((a,t) => a + (t.prob_non_exec || 0), 0) / 100,
                daily_non_exec_rec: validTrips.reduce((a,t) => a + (t.prob_non_exec_rec || 0), 0) / 100,
                rec_increase: trips.filter(t => t.rec === '×œ×”×¢×œ×•×ª').length
            });
        }

        progress.querySelector('.progress-bar').style.width = '100%';
        
        // === VALIDATION SUMMARY ===
        console.log(`\nğŸ“ˆ Trip Matching Summary:`);
        console.log(`   âœ… Full match (â‰¥10 records): ${tripsWithData}`);
        console.log(`   âš ï¸ Partial match (<10 records): ${tripsPartialData}`);
        console.log(`   âŒ No match: ${tripsWithoutData}`);
        console.log(`   ğŸ“Š Match rate: ${((tripsWithData / (tripsWithData + tripsPartialData + tripsWithoutData)) * 100).toFixed(1)}%`);
        
        // Show RouteId info box with validation details
        const hasRouteIds = tripsResults.some(t => t.route_id);
        const routeIdInfoEl = document.getElementById('routeIdInfo');
        if (hasRouteIds) {
            const matchRate = ((tripsWithData / (tripsWithData + tripsPartialData + tripsWithoutData)) * 100).toFixed(1);
            
            let warningClass = unmatchedRouteIds.length > 0 ? 'warning' : '';
            let statusIcon = unmatchedRouteIds.length > 0 ? 'âš ï¸' : 'âœ…';
            
            routeIdInfoEl.className = `info-box ${warningClass}`;
            routeIdInfoEl.style.display = 'block';
            routeIdInfoEl.innerHTML = `
                <strong>${statusIcon} ×¡×˜×˜×•×¡ ×”×ª×××ª × ×ª×•× ×™×:</strong><br>
                â€¢ ××§"×˜×™× ×‘-Actuals: <strong>${routeIdsInActuals.size}</strong> |
                â€¢ ××§"×˜×™× ×‘××¤×”: <strong>${routeIdsInMap.size}</strong> |
                â€¢ ××§"×˜×™× ××•×ª×××™×: <strong>${matchedRouteIds.length}</strong><br>
                â€¢ × ×¡×™×¢×•×ª ×¢× × ×ª×•× ×™× ××œ××™×: <strong>${tripsWithData}</strong> |
                â€¢ × ×¡×™×¢×•×ª ×¢× × ×ª×•× ×™× ×—×œ×§×™×™×: <strong>${tripsPartialData}</strong> |
                â€¢ × ×¡×™×¢×•×ª ×œ×œ× × ×ª×•× ×™×: <strong>${tripsWithoutData}</strong> |
                â€¢ ××—×•×– ×”×ª×××”: <strong>${matchRate}%</strong>
                ${unmatchedRouteIds.length > 0 ? `<br><span style="color: var(--accent-yellow);">âš ï¸ ${unmatchedRouteIds.length} ××§"×˜×™× ×‘××¤×” ×œ×œ× × ×ª×•× ×™× ×‘-Actuals: ${unmatchedRouteIds.slice(0, 10).join(', ')}${unmatchedRouteIds.length > 10 ? '...' : ''}</span>` : ''}
            `;
        } else {
            routeIdInfoEl.style.display = 'none';
        }
        
        renderSummary(); renderTrips(); renderDuties(); renderRoutes(); renderDeadheads(); populateFilters();
        document.getElementById('results').classList.remove('hidden');
        progress.classList.add('hidden');
        btn.disabled = false; btn.textContent = 'ğŸ” × ×ª×— × ×ª×•× ×™×';
    }

    // === Render Functions ===
    function renderSummary() {
        const withData = tripsResults.filter(t => !t.no_data && !t.is_last);
        const noDataCount = tripsResults.filter(t => t.no_data).length;
        const targetNE = parseFloat(document.getElementById('targetNE').value);
        const targetIN = parseFloat(document.getElementById('targetIN').value);
        const totalTrips = withData.length;
        
        const failsNE = withData.filter(t => t.prob_non_exec !== null && t.prob_non_exec > targetNE).length;
        const failsIN = withData.filter(t => t.prob_non_exec !== null && t.prob_non_exec <= targetNE && t.prob_inaccuracy > targetIN).length;
        const failsNE_rec = withData.filter(t => t.prob_non_exec_rec !== null && t.prob_non_exec_rec > targetNE).length;
        const failsIN_rec = withData.filter(t => t.prob_non_exec_rec !== null && t.prob_non_exec_rec <= targetNE && t.prob_inaccuracy_rec > targetIN).length;
        
        const pctNE = totalTrips > 0 ? (failsNE / totalTrips) * 100 : 0;
        const pctIN = totalTrips > 0 ? (failsIN / totalTrips) * 100 : 0;
        const pctNE_rec = totalTrips > 0 ? (failsNE_rec / totalTrips) * 100 : 0;
        const pctIN_rec = totalTrips > 0 ? (failsIN_rec / totalTrips) * 100 : 0;
        
        const d168PlanFail = dutiesResults.filter(d => !d.plan_compliant).length;
        const d168ActualFail = dutiesResults.filter(d => !d.actual_compliant).length;
        
        document.getElementById('summaryStats').innerHTML = `
            <div class="stat-card"><div class="value blue">${tripsResults.length}</div><div class="label">× ×¡×™×¢×•×ª</div></div>
            <div class="stat-card">
                <div class="value ${pctNE > 2 ? 'red' : 'green'}">${pctNE.toFixed(2)}%</div>
                <div class="label">××™-×‘×™×¦×•×¢ (× ×•×›×—×™)</div>
                ${pctNE_rec < pctNE ? `<div class="sub">â†’ ${pctNE_rec.toFixed(2)}% ××—×¨×™ ×”××œ×¦×”</div>` : ''}
                <div style="font-size:0.6rem;color:var(--text-secondary);">${failsNE} × ×¡×™×¢×•×ª ×—×•×¨×’×•×ª</div>
            </div>
            <div class="stat-card">
                <div class="value ${pctIN > 3 ? 'yellow' : 'green'}">${pctIN.toFixed(2)}%</div>
                <div class="label">××™-×“×™×•×§ (× ×•×›×—×™)</div>
                ${pctIN_rec < pctIN ? `<div class="sub">â†’ ${pctIN_rec.toFixed(2)}% ××—×¨×™ ×”××œ×¦×”</div>` : ''}
                <div style="font-size:0.6rem;color:var(--text-secondary);">${failsIN} × ×¡×™×¢×•×ª ×—×•×¨×’×•×ª</div>
            </div>
            <div class="stat-card"><div class="value ${noDataCount>0?'purple':'green'}">${noDataCount}</div><div class="label">××™×Ÿ × ×ª×•× ×™×</div></div>
            <div class="stat-card"><div class="value ${d168PlanFail>0?'purple':'green'}">${d168PlanFail}</div><div class="label">168 ×ª×›× ×•×Ÿ âœ—</div></div>
            <div class="stat-card"><div class="value ${d168ActualFail>0?'red':'green'}">${d168ActualFail}</div><div class="label">168 ××—×•×–×•×Ÿ âœ—</div></div>
        `;
    }

    function renderTrips() {
        const targetNE = parseFloat(document.getElementById('targetNE').value);
        const targetIN = parseFloat(document.getElementById('targetIN').value);
        const routeIdF = document.getElementById('filterRouteId').value;
        const routeF = document.getElementById('filterRoute').value;
        const statusF = document.getElementById('filterStatus').value;
        const recF = document.getElementById('filterRec').value;
        const f168 = document.getElementById('filter168').value;
        
        let filtered = tripsResults.filter(t => {
            if (routeIdF && t.route_id != routeIdF) return false;
            if (routeF && t.route != routeF) return false;
            if (recF && t.rec !== recF) return false;
            if (statusF === 'fail_ne' && (t.no_data || t.prob_non_exec <= targetNE)) return false;
            if (statusF === 'fail_in' && (t.no_data || t.prob_non_exec > targetNE || t.prob_inaccuracy <= targetIN)) return false;
            if (statusF === 'ok' && (t.no_data || t.prob_non_exec > targetNE || t.prob_inaccuracy > targetIN)) return false;
            if (statusF === 'no_data' && !t.no_data) return false;
            if (f168 === 'plan_fail' && t.duty_168_plan) return false;
            if (f168 === 'actual_fail' && t.duty_168_actual) return false;
            return true;
        });
        
        filtered.sort((a,b) => {
            let av = a[tripsSortCol] ?? -1, bv = b[tripsSortCol] ?? -1;
            if (typeof av === 'string') return tripsSortDir === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av);
            return tripsSortDir === 'asc' ? av - bv : bv - av;
        });
        
        document.getElementById('tripsBody').innerHTML = filtered.slice(0, 500).map(t => {
            const neOk = t.no_data || t.prob_non_exec === null || t.prob_non_exec <= targetNE;
            const inOk = t.no_data || t.prob_inaccuracy === null || t.prob_inaccuracy <= targetIN;
            let status = t.no_data ? '<span class="badge badge-gray">N/A</span>' :
                        t.is_ignored ? '<span class="badge badge-gray">GPS</span>' :
                        !neOk ? '<span class="badge badge-red">NE</span>' :
                        !inOk ? '<span class="badge badge-yellow">IN</span>' :
                        '<span class="badge badge-green">âœ“</span>';
            
            const recClass = t.rec === '×œ×”×¢×œ×•×ª' ? 'badge-red' : t.rec === '×œ×‘×—×•×Ÿ ×”×¢×œ××”' ? 'badge-yellow' : t.rec === '××™×Ÿ × ×ª×•× ×™×' ? 'badge-gray' : 'badge-green';
            const pctClass = t.dynamic_pct === 'N/A' ? 'badge-gray' : t.dynamic_pct === 'P95' ? 'badge-orange' : t.dynamic_pct === 'P90' ? 'badge-blue' : t.dynamic_pct === 'GPS' ? 'badge-gray' : 'badge-green';
            
            const probNEText = t.prob_non_exec === null ? '-' : t.prob_non_exec.toFixed(1) + '%';
            const probNERecText = t.prob_non_exec_rec === null ? '-' : t.prob_non_exec_rec.toFixed(1) + '%';
            const probINText = t.prob_inaccuracy === null ? '-' : t.prob_inaccuracy.toFixed(1) + '%';
            const neRecImproved = t.prob_non_exec_rec !== null && t.prob_non_exec !== null && t.prob_non_exec_rec < t.prob_non_exec;
            
            return `<tr class="${!t.no_data && t.prob_non_exec > 5 ? 'highlight-row' : ''}">
                <td>${t.duty_id}</td>
                <td><span class="badge badge-cyan">${t.route_id || '-'}</span></td>
                <td><strong>${t.route}</strong></td>
                <td>${t.direction}</td><td>${t.start_time}</td><td>${t.planned}'</td>
                <td><span class="badge ${pctClass}">${t.dynamic_pct}</span></td><td><strong>${t.pct_value.toFixed(0)}'</strong></td>
                <td>${t.is_last ? '<span class="badge badge-blue">××—×¨×•×Ÿ</span>' : t.gap_to_next + "'"}</td>
                <td style="color:${!neOk&&!t.no_data?'var(--accent-red)':''}">${probNEText}</td>
                <td style="color:${neRecImproved?'var(--accent-green)':''}">${probNERecText}</td>
                <td style="color:${!inOk&&!t.no_data?'var(--accent-yellow)':''}">${probINText}</td>
                <td>${status}</td><td><span class="badge ${recClass}">${t.rec}</span></td><td><strong>${t.rec_duration}'</strong></td>
                <td>${t.duty_168_plan?'<span class="badge badge-green">âœ“</span>':'<span class="badge badge-purple">âœ—</span>'}</td>
                <td>${t.duty_168_actual?'<span class="badge badge-green">âœ“</span>':'<span class="badge badge-red">âœ—</span>'}</td>
            </tr>`;
        }).join('');
    }

    function renderDuties() {
        const f168 = document.getElementById('filterDuty168').value;
        let filtered = dutiesResults.filter(d => {
            if (f168 === 'both_ok' && (!d.plan_compliant || !d.actual_compliant)) return false;
            if (f168 === 'plan_ok_actual_fail' && (!d.plan_compliant || d.actual_compliant)) return false;
            if (f168 === 'plan_fail' && d.plan_compliant) return false;
            return true;
        });
        
        document.getElementById('dutiesBody').innerHTML = filtered.map(d => {
            return `<tr>
                <td><strong>${d.duty_id}</strong></td><td>${d.startTime}</td><td>${d.endTime}</td>
                <td>${(d.total_duration/60).toFixed(1)}h</td>
                <td>${d.plan_compliant?'<span class="badge badge-green">âœ“</span>':'<span class="badge badge-purple">âœ—</span>'}</td>
                <td>${d.actual_compliant?'<span class="badge badge-green">âœ“</span>':'<span class="badge badge-red">âœ—</span>'}</td>
            </tr>`;
        }).join('');
    }

    function renderRoutes() {
        const routeIdF = document.getElementById('filterRoutesRouteId').value;
        
        let filtered = routesResults.filter(r => {
            if (routeIdF && r.route_id != routeIdF) return false;
            return true;
        });
        
        filtered.sort((a,b) => {
            let av = a[routesSortCol] ?? 0, bv = b[routesSortCol] ?? 0;
            return routesSortDir === 'asc' ? av - bv : bv - av;
        });
        
        document.getElementById('routesBody').innerHTML = filtered.map(r => {
            const neColor = r.avg_non_exec > 5 ? 'var(--accent-red)' : r.avg_non_exec > 2 ? 'var(--accent-yellow)' : 'var(--accent-green)';
            const pctClass = r.pct_label === 'P95' ? 'badge-orange' : r.pct_label === 'GPS' ? 'badge-gray' : 'badge-blue';
            const improved = r.daily_non_exec_rec < r.daily_non_exec;
            const dailyText = improved ? 
                `${r.daily_non_exec.toFixed(1)}<span style="color:var(--accent-green);font-size:0.7rem;"> â†’${r.daily_non_exec_rec.toFixed(1)}</span>` : 
                r.daily_non_exec.toFixed(1);
            return `<tr>
                <td><span class="badge badge-cyan">${r.route_id || '-'}</span></td>
                <td><strong>×§×• ${r.route}</strong></td>
                <td>${r.trips}</td>
                <td>${r.data_count}</td>
                <td><span class="badge ${pctClass}">${r.pct_label}</span></td>
                <td style="color:${neColor}">${r.avg_non_exec.toFixed(2)}%</td>
                <td>${r.avg_inaccuracy.toFixed(2)}%</td>
                <td>${dailyText}</td>
                <td>${r.rec_increase}</td>
            </tr>`;
        }).join('');
    }
    
    function renderDeadheads() {
        const statusF = document.getElementById('filterDeadheadStatus').value;
        const seasonF = document.getElementById('filterDeadheadSeason').value;
        
        let filtered = deadheadsResults.filter(d => {
            if (statusF && d.status !== statusF) return false;
            if (seasonF && d.season_key !== seasonF) return false;
            return true;
        });
        
        const statusOrder = { 'map_zero': 0, 'long': 1, 'short': 2, 'catalog_missing': 3, 'ok': 4 };
        filtered.sort((a,b) => {
            if (deadheadsSortCol === 'status') {
                return deadheadsSortDir === 'asc' ? statusOrder[a.status] - statusOrder[b.status] : statusOrder[b.status] - statusOrder[a.status];
            }
            let av = a[deadheadsSortCol] ?? -999, bv = b[deadheadsSortCol] ?? -999;
            return deadheadsSortDir === 'asc' ? av - bv : bv - av;
        });
        
        const dhOk = deadheadsResults.filter(d => d.status === 'ok').length;
        const dhLong = deadheadsResults.filter(d => d.status === 'long').length;
        const dhShort = deadheadsResults.filter(d => d.status === 'short').length;
        const dhMapZero = deadheadsResults.filter(d => d.status === 'map_zero').length;
        const dhCatalogMissing = deadheadsResults.filter(d => d.status === 'catalog_missing').length;
        
        document.getElementById('deadheadsSummary').innerHTML = `
            <div class="stat-card"><div class="value green">${dhOk}</div><div class="label">OK</div></div>
            <div class="stat-card"><div class="value orange">${dhMapZero}</div><div class="label">âš ï¸ ×—×¡×¨ ×‘××¤×”</div></div>
            <div class="stat-card"><div class="value red">${dhLong}</div><div class="label">LONG</div></div>
            <div class="stat-card"><div class="value yellow">${dhShort}</div><div class="label">SHORT</div></div>
            <div class="stat-card"><div class="value purple">${dhCatalogMissing}</div><div class="label">×—×¡×¨ ×‘×§×˜×œ×•×’</div></div>
        `;
        
        document.getElementById('deadheadsBody').innerHTML = filtered.slice(0, 500).map(d => {
            const statusBadge = d.status === 'ok' ? '<span class="badge badge-green">OK</span>' :
                               d.status === 'long' ? '<span class="badge badge-red">LONG</span>' :
                               d.status === 'short' ? '<span class="badge badge-yellow">SHORT</span>' :
                               d.status === 'map_zero' ? '<span class="badge badge-orange">âš ï¸ ×—×¡×¨ ×‘××¤×”</span>' :
                               '<span class="badge badge-purple">×—×¡×¨ ×‘×§×˜×œ×•×’</span>';
            
            const diffText = d.diff !== null ? (d.diff > 0 ? `+${d.diff}` : d.diff) : '-';
            const diffColor = d.diff === null ? '' : d.status === 'map_zero' ? 'color:var(--accent-orange)' :
                             d.diff > 5 ? 'color:var(--accent-red)' : d.diff < -5 ? 'color:var(--accent-yellow)' : 'color:var(--accent-green)';
            const rowClass = d.status === 'map_zero' ? 'warning-row' : d.status === 'long' ? 'highlight-row' : '';
            
            return `<tr class="${rowClass}">
                <td>${d.duty_id}</td><td>${d.start_time}</td><td><span class="badge badge-blue">${d.season_label}</span></td>
                <td title="${d.origin_id}">${d.origin_name || d.origin_id}</td>
                <td title="${d.dest_id}">${d.dest_name || d.dest_id}</td>
                <td><strong>${d.map_duration}'</strong></td><td>${d.catalog_duration !== null ? d.catalog_duration + "'" : '-'}</td>
                <td style="${diffColor}"><strong>${diffText}</strong></td><td>${statusBadge}</td>
            </tr>`;
        }).join('');
    }

    function populateFilters() {
        // RouteId filter for trips
        const routeIdSelect = document.getElementById('filterRouteId');
        const routeIds = [...new Set(tripsResults.map(t => t.route_id).filter(r => r))].sort();
        routeIdSelect.innerHTML = '<option value="">×›×œ ×”××§"×˜×™×</option>' + routeIds.map(r => `<option value="${r}">${r}</option>`).join('');
        
        // Route filter for trips
        const routeSelect = document.getElementById('filterRoute');
        const routes = [...new Set(tripsResults.map(t => t.route))].sort((a,b) => a-b);
        routeSelect.innerHTML = '<option value="">×›×œ ×”×§×•×•×™×</option>' + routes.map(r => `<option value="${r}">×§×• ${r}</option>`).join('');
        
        // RouteId filter for routes tab
        const routesRouteIdSelect = document.getElementById('filterRoutesRouteId');
        routesRouteIdSelect.innerHTML = '<option value="">×›×œ ×”××§"×˜×™×</option>' + routeIds.map(r => `<option value="${r}">${r}</option>`).join('');
    }

    function sortTrips(col) {
        if (tripsSortCol === col) tripsSortDir = tripsSortDir === 'asc' ? 'desc' : 'asc';
        else { tripsSortCol = col; tripsSortDir = 'desc'; }
        renderTrips();
    }
    
    function sortRoutes(col) {
        if (routesSortCol === col) routesSortDir = routesSortDir === 'asc' ? 'desc' : 'asc';
        else { routesSortCol = col; routesSortDir = 'desc'; }
        renderRoutes();
    }
    
    function sortDeadheads(col) {
        if (deadheadsSortCol === col) deadheadsSortDir = deadheadsSortDir === 'asc' ? 'desc' : 'asc';
        else { deadheadsSortCol = col; deadheadsSortDir = 'desc'; }
        renderDeadheads();
    }
    
    function sortDuties(col) { renderDuties(); }

    // === Export Functions ===
    function exportTripsCSV() {
        const headers = ['×¡×™×“×•×¨','××§×˜','×§×•','×›×™×•×•×Ÿ','×™×¦×™××”','×ª×›× ×•×Ÿ','××—×•×–×•×Ÿ','×¢×¨×š','×¤×¢×¨','NE_× ×•×›×—×™','NE_××—×¨×™','IN_× ×•×›×—×™','×”××œ×¦×”','×”×’×“×¨×”','168_×ª×›× ×•×Ÿ','168_××—×•×–×•×Ÿ'];
        let csv = headers.join(',') + '\n';
        tripsResults.forEach(t => {
            csv += [t.duty_id, t.route_id || '', t.route, t.direction, t.start_time, t.planned, t.dynamic_pct, t.pct_value?.toFixed(1),
                t.is_last ? '××—×¨×•×Ÿ' : t.gap_to_next, t.prob_non_exec?.toFixed(2) || '-', t.prob_non_exec_rec?.toFixed(2) || '-',
                t.prob_inaccuracy?.toFixed(2) || '-', t.rec, t.rec_duration, t.duty_168_plan?'V':'X', t.duty_168_actual?'V':'X'].join(',') + '\n';
        });
        downloadCSV(csv, 'trips_analysis.csv');
    }

    function exportDutiesCSV() {
        const headers = ['×¡×™×“×•×¨','×”×ª×—×œ×”','×¡×™×•×','××©×š','168_×ª×›× ×•×Ÿ','168_××—×•×–×•×Ÿ'];
        let csv = headers.join(',') + '\n';
        dutiesResults.forEach(d => {
            csv += [d.duty_id, d.startTime, d.endTime, (d.total_duration/60).toFixed(1), d.plan_compliant?'V':'X', d.actual_compliant?'V':'X'].join(',') + '\n';
        });
        downloadCSV(csv, 'duties_rule168.csv');
    }
    
    function exportDeadheadsCSV() {
        const headers = ['×¡×™×“×•×¨','×©×¢×”','×¢×•× ×”','××•×¦×_ID','×™×¢×“_ID','××•×¦×','×™×¢×“','××¤×”_×“×§×•×ª','×§×˜×œ×•×’_×“×§×•×ª','×¤×¢×¨','×¡×˜×˜×•×¡'];
        let csv = headers.join(',') + '\n';
        deadheadsResults.forEach(d => {
            csv += [d.duty_id, d.start_time, d.season_label, d.origin_id, d.dest_id, 
                    `"${d.origin_name}"`, `"${d.dest_name}"`,
                    d.map_duration, d.catalog_duration || '-', d.diff || '-', d.status_label].join(',') + '\n';
        });
        downloadCSV(csv, 'deadheads_analysis.csv');
    }

    function downloadCSV(content, filename) {
        const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(a.href); }, 100);
    }

    // === Event Listeners for Filters ===
    ['filterRouteId','filterRoute','filterStatus','filterRec','filter168'].forEach(id => document.getElementById(id).addEventListener('change', renderTrips));
    document.getElementById('filterDuty168').addEventListener('change', renderDuties);
    document.getElementById('filterRoutesRouteId').addEventListener('change', renderRoutes);
    document.getElementById('filterDeadheadStatus').addEventListener('change', renderDeadheads);
    document.getElementById('filterDeadheadSeason').addEventListener('change', renderDeadheads);
    </script>
</body>
</html>
